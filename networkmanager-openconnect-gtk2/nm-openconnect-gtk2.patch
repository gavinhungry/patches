diff -ru aur/networkmanager-openconnect-gtk2.ORIG/src/NetworkManager-openconnect-0.9.8.6/auth-dialog/main.c aur/networkmanager-openconnect-gtk2/src/NetworkManager-openconnect-0.9.8.6/auth-dialog/main.c
--- aur/networkmanager-openconnect-gtk2.ORIG/src/NetworkManager-openconnect-0.9.8.6/auth-dialog/main.c	2015-05-06 14:55:10.497719902 -0700
+++ aur/networkmanager-openconnect-gtk2/src/NetworkManager-openconnect-0.9.8.6/auth-dialog/main.c	2015-05-06 14:55:17.397813883 -0700
@@ -58,7 +58,6 @@
 #endif
 
 #if !OPENCONNECT_CHECK_VER(1,5)
-#define OPENCONNECT_X509 X509
 #define OPENCONNECT_OPENSSL
 #endif
 
@@ -88,6 +87,21 @@
 #define OC_FORM_RESULT_NEWGROUP		2
 #endif
 
+#if OPENCONNECT_CHECK_VER(4,0)
+#define dup_option_value(opt)		g_strdup((opt)->_value);
+#define OC3DUP(x)			(x)
+#define write_config_const		const
+#else
+#define dup_option_value(opt)		g_strdup((opt)->value);
+#define openconnect_set_option_value(opt, val) do { \
+		struct oc_form_opt *_o = (opt);				\
+		free(_o->value); _o->value = g_strdup(val);		\
+	} while (0)
+#define openconnect_free_cert_info(v, x) free(x)
+#define OC3DUP(x)			g_strdup(x)
+#define write_config_const		/* */
+#endif
+
 #ifdef OPENCONNECT_OPENSSL
 #include <openssl/ssl.h>
 #include <openssl/bio.h>
@@ -723,7 +737,7 @@
 				data->entry_text = g_strdup (find_form_answer(ui_data->secrets,
 									      form, opt));
 				if (!data->entry_text)
-					data->entry_text = g_strdup (opt->value);
+					data->entry_text = dup_option_value(opt);
 			} else {
 				data->find_request = gnome_keyring_find_password(
 						OPENCONNECT_SCHEMA,
@@ -786,8 +800,7 @@
 		for (i = 0; i < sopt->nr_choices; i++) {
 			struct oc_choice *ch = FORMCHOICE(sopt, i);
 			if (!strcmp(saved_group, ch->name) && i != AUTHGROUP_SELECTION(form)) {
-				free(opt->value);
-				opt->value = g_strdup(saved_group);
+				openconnect_set_option_value(opt, saved_group);
 				return TRUE;
 			}
 		}
@@ -833,7 +846,7 @@
 				gnome_keyring_cancel_request(data->find_request);
 
 			if (data->entry_text) {
-				data->opt->value = g_strdup (data->entry_text);
+				openconnect_set_option_value(data->opt, data->entry_text);
 
 				if (data->opt->type == OC_FORM_OPT_TEXT ||
 				    data->opt->type == OC_FORM_OPT_SELECT) {
@@ -884,7 +897,7 @@
 
 typedef struct cert_data {
 	auth_ui_data *ui_data;
-	OPENCONNECT_X509 *peer_cert;
+	char *cert_details;
 	const char *reason;
 } cert_data;
 
@@ -912,13 +925,10 @@
 {
 	auth_ui_data *ui_data = _ui_data; /* FIXME global */
 	char *title;
-	char *details;
 	GtkWidget *dlg, *text, *scroll;
 	GtkTextBuffer *buffer;
 	int result;
 
-	details = openconnect_get_cert_details(ui_data->vpninfo, data->peer_cert);
-
 	title = get_title(data->ui_data->vpn_name);
 	dlg = gtk_message_dialog_new(NULL, 0, GTK_MESSAGE_QUESTION,
 				     GTK_BUTTONS_OK_CANCEL,
@@ -941,8 +951,7 @@
 
 	text = gtk_text_view_new();
 	buffer = gtk_text_view_get_buffer(GTK_TEXT_VIEW(text));
-	gtk_text_buffer_set_text(buffer, details, -1);
-	free(details);
+	gtk_text_buffer_set_text(buffer, data->cert_details, -1);
 	gtk_text_view_set_editable(GTK_TEXT_VIEW(text), 0);
 	gtk_text_view_set_cursor_visible(GTK_TEXT_VIEW(text), FALSE);
 	gtk_container_add(GTK_CONTAINER(scroll), text);
@@ -964,18 +973,14 @@
 }
 
 /* runs in worker thread */
-static int validate_peer_cert(void *cbdata,
-			      OPENCONNECT_X509 *peer_cert, const char *reason)
+static int validate_peer_cert(void *cbdata, const char *reason)
 {
 	auth_ui_data *ui_data = cbdata;
-	char fingerprint[41];
 	char *certs_data;
 	int ret = 0;
 	cert_data *data;
 
-	ret = openconnect_get_cert_sha1(ui_data->vpninfo, peer_cert, fingerprint);
-	if (ret)
-		return ret;
+	const char *fingerprint = openconnect_get_peer_cert_hash(ui_data->vpninfo);
 
 	certs_data = g_hash_table_lookup (ui_data->secrets, "certsigs");
 	if (certs_data) {
@@ -994,7 +999,6 @@
 
 	data = g_slice_new(cert_data);
 	data->ui_data = ui_data; /* FIXME uses global */
-	data->peer_cert = peer_cert;
 	data->reason = reason;
 
 	g_mutex_lock(ui_data->form_mutex);
@@ -1389,7 +1393,7 @@
 		}
 		ui_data->retval = 1;
 	} else if (!ui_data->cookie_retval) {
-		OPENCONNECT_X509 *cert;
+		const void *cert;
 		gchar *key, *value;
 
 		/* got cookie */
@@ -1411,11 +1415,10 @@
 		g_hash_table_insert (ui_data->secrets, key, value);
 		openconnect_clear_cookie(ui_data->vpninfo);
 
-		cert = openconnect_get_peer_cert (ui_data->vpninfo);
+		cert = openconnect_get_peer_cert_hash (ui_data->vpninfo);
 		if (cert) {
 			key = g_strdup (NM_OPENCONNECT_KEY_GWCERT);
-			value = g_malloc0 (41);
-			openconnect_get_cert_sha1(ui_data->vpninfo, cert, value);
+			value = g_strdup (cert);
 			g_hash_table_insert (ui_data->secrets, key, value);
 		}
 
